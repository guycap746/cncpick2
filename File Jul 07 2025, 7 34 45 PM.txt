ğŸ§ª Simulation Harness Guide â€“ cncpick2

This guide explains how to run the simulation environment, feed test scenarios, validate agent behavior, and switch between simulation and real hardware configurations.

â¸»

ğŸ“‚ Project Folder Expectations

/tests
  /logs
  /scenarios
    sanity_test.json
  test_runner.py
  assert_helpers.py

/config
  sim_config.yaml
  real_config.yaml

/agents
  simulator_agent.py
  vision_agent.py
  motion_agent_1.py
  trigger_agent_1.py
  ...


â¸»

ğŸš€ Launching the Simulation

To launch the full simulation pipeline:

python tests/test_runner.py --scenario tests/scenarios/sanity_test.json

The test runner:
	â€¢	Loads the test scenario
	â€¢	Launches required agents (in sim mode)
	â€¢	Feeds test data into the simulator_agent
	â€¢	Validates results using assert_helpers
	â€¢	Writes logs and summary output

â¸»

ğŸ§ª Test Scenarios

Scenarios are defined in /tests/scenarios/*.json. Example:

[
  {"object_id": "uuid1", "lane": 0, "delay_ms": 1000},
  {"object_id": "uuid2", "lane": 1, "delay_ms": 1500}
]

	â€¢	delay_ms is the delay before object enters simulated vision range
	â€¢	Lane determines motion agent targeting

â¸»

ğŸ§¾ Logging Output

All agent PUB messages are collected by data_logging_agent, and saved to:
	â€¢	/tests/logs/sanity_test_full.jsonl
	â€¢	/tests/logs/results_summary.json

Sample log entry:

{
  "event": "object_detected",
  "agent": "vision_agent",
  "timestamp": "...",
  "payload": {
    "object_id": "uuid1",
    "lane": 2,
    "height_mm": 32.1,
    "area_px": 3112
  }
}


â¸»

âœ… Validating Simulation

The assert_helpers.py module validates:
	â€¢	Object was spawned by simulator
	â€¢	Detection contains lane + height
	â€¢	Correct assignment from scoring agent
	â€¢	Pickup and drop events occurred in correct order

Run results:
	â€¢	Print validation results to terminal
	â€¢	Write summary counts to JSON:

{
  "object_spawned": 2,
  "object_detected": 2,
  "object_assigned": 2,
  "object_picked": 2,
  "object_dropped": 2
}


â¸»

ğŸ” Switching Between Sim and Real

Configuration file: /config/sim_config.yaml

hardware_mode: sim
camera_input: fake_rgbd
grbl_device: sim_driver
vacuum_control: gcode_m8_m9

Set hardware_mode: real for live CNC + camera systems. This affects:
	â€¢	grbl_driver_agent
	â€¢	camera_input interface
	â€¢	Logging behavior (can increase verbosity for real hardware)

â¸»

âš™ï¸ CI Integration

The simulation can be run in CI:

- name: Run Simulation Sanity Test
  run: |
    python tests/test_runner.py --scenario tests/scenarios/sanity_test.json


â¸»

ğŸ“Œ Tips
	â€¢	Use small test cases first (one object per lane)
	â€¢	Confirm motion_agent_ready signals return to scoring_agent
	â€¢	Inspect missed objects via post_pick_monitor_agent

â¸»

ğŸš§ Planned Enhancements
	â€¢	Visual simulation playback tool
	â€¢	Scenario generator CLI tool
	â€¢	Support for noisy detections and failure injection

â¸»

This guide ensures all developers and testers can:
	â€¢	Understand how the simulation works
	â€¢	Modify and create their own scenarios
	â€¢	Reproduce issues with consistent input
	â€¢	Validate system correctness in isolation from hardware